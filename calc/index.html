<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ZEUS AI — Калькулятор сложных процентов</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='%2338e8ff' d='M28 4l-6 20h10l-8 28 20-26H34l10-22z'/%3E%3C/svg%3E">
<script src="./assets/js/chartjs-official/chart.umd.min.js"></script>
<style>
:root{--bg:#08142f;--panel:#0e1d3f;--text:#d7eaff;--muted:#9fb7ff;--cyan:#38e8ff;--border:#38e8ff33;--hl:#12305e}
*{box-sizing:border-box}
body{margin:0;background:radial-gradient(1000px 600px at 85% 10%, rgba(56,232,255,.08) 0%, rgba(56,232,255,0) 70%),radial-gradient(1200px 600px at 10% 0%,#13214a 0%,#0b1330 55%,#081027 100%);color:var(--text);font-family:Inter,ui-sans-serif,system-ui}
.wrap{max-width:1180px;margin:0 auto;padding:18px 14px 40px}
h1{margin:10px 0 8px;color:var(--cyan)}
.topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:8px 0 12px}
.menu{display:flex;gap:8px;flex-wrap:wrap}
.btn{background:var(--hl);border:1px solid var(--border);color:#fff;border-radius:14px;padding:8px 12px;cursor:pointer}
.card{background:linear-gradient(180deg,var(--panel),#0b1836);border:1px solid var(--border);border-radius:16px;padding:14px;margin-top:14px}
.ctitle{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.pill{font-size:12px;color:#9bdfff;border:1px solid var(--border);padding:3px 8px;border-radius:12px}
.fields label{display:block;font-size:14px;margin-bottom:8px}
.fields input,.fields select{width:100%;background:#091537;border:1px solid var(--border);border-radius:10px;color:var(--text);padding:8px 10px}
.row{display:grid;gap:10px}.row.two{grid-template-columns:repeat(2,minmax(160px,1fr))}.row.three{grid-template-columns:repeat(3,minmax(120px,1fr))}
.grid{display:grid;grid-template-columns:minmax(340px,520px) minmax(360px,1fr);gap:18px}
.kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
.mini{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:12px;padding:10px}
.mini .label{font-size:12px;color:#9fb7ff}.mini .value{font-weight:700}
.segment{display:inline-flex;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.segment input{display:none}.segment label{padding:8px 10px;font-size:13px;color:#cfeaff;cursor:pointer}.segment input:checked+label{background:#12305e;color:#fff}
.affGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:8px}
.hint{font-size:12px;color:#9fb7ff;margin-top:4px}
table{width:100%;border-collapse:collapse;margin-top:6px}th,td{border-bottom:1px dashed #2b3f6a;padding:6px 8px;text-align:right}th:first-child,td:first-child{text-align:left}
canvas{width:100%;height:340px}
.i{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;margin-left:6px;border-radius:50%;border:1px solid var(--border);color:#9bdfff;font-size:12px;cursor:help;position:relative}
.i:hover::after{content:attr(data-tip);position:absolute;left:20px;top:-4px;min-width:220px;max-width:360px;background:#0a1840;color:#cfeaff;border:1px solid var(--border);padding:8px 10px;border-radius:10px;white-space:normal;z-index:10}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1>Калькулятор сложных процентов</h1>
    <div class="menu">
      <button class="btn" id="btnReset" title="Сбросить все поля к значениям по умолчанию">Сброс</button>
      <button class="btn" id="btnHelp" title="Поясняющая инструкция и формулы">Инструкция</button>
      <button class="btn" id="btnShare" title="Сформировать ссылку с параметрами текущего расчёта">Поделиться</button>
      <button class="btn" id="btnPNG" title="Скачать общий PNG с графиком и KPI">PNG</button>
      <button class="btn" id="btnPDF" title="Экспорт в PDF через диалог печати">PDF</button>
      <button class="btn" id="btnCSV" title="Скачать CSV с таблицей и партнёркой">CSV</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="ctitle"><h3>Параметры</h3><span class="pill">ZEUS AI</span></div>
      <div class="fields">
        <div class="segment">
          <input type="radio" id="modeAnnual" name="mode" value="annual" checked><label for="modeAnnual">Годовая ставка</label>
          <input type="radio" id="modeMonthly" name="mode" value="monthly"><label for="modeMonthly">Месячная ставка</label>
        </div>
        <div id="annualBox" class="row two" style="margin-top:8px">
          <label>Годовая ставка, % <span class="i" data-tip="Номинальная годовая ставка (APR). Комиссия вычитается ниже.">i</span><input type="number" id="rate" value="24" step="0.01"></label>
          <label>Комиссия/издержки, % <span class="i" data-tip="Годовые комиссии/издержки. Вычитаются из ставки перед начислением.">i</span><input type="number" id="fee" value="0" step="0.01"></label>
        </div>
        <div id="monthlyBox" class="row two" style="margin-top:8px;display:none">
          <label>Месячная ставка, % <span class="i" data-tip="Средняя доходность за месяц (m). Конвертируется в годовую EAR как (1+m)^12-1.">i</span><input type="number" id="mrate" value="2" step="0.001"></label>
          <label>Колебания, ±% <span class="i" data-tip="Диапазон отклонений месячной доходности для подсказки по нижней/верхней годовой.">i</span><input type="number" id="mvol" value="0" step="0.01"></label>
          <div class="hint">Годовая EAR из месячной: <b id="earFromMonthly">—</b></div>
        </div>
        <div class="row two">
          <label>Первоначальная сумма <span class="i" data-tip="Депозит на старте периода. Если ≥ $3k — активируется собственный доход 50% от прибыли.">i</span><input type="number" id="initial" value="3000" step="1" min="0"></label>
          <label>Регулярное пополнение <span class="i" data-tip="Фиксированная сумма, вносимая каждый период (см. частоту слева).">i</span><input type="number" id="contrib" value="0" step="1" min="0"></label>
        </div>
        <div class="row two">
          <label>Частота пополнений <span class="i" data-tip="Сколько раз в год вносите регулярное пополнение. 0 — без пополнений.">i</span><select id="contribFreq"><option value="12" selected>Ежемесячно (12)</option><option value="4">Ежеквартально (4)</option><option value="1">Ежегодно (1)</option><option value="0">Без пополнений</option></select></label>
          <label>Капитализация <span class="i" data-tip="Как часто начисляются проценты в год. Влияет на эффективную годовую (EAR).">i</span><select id="compound"><option value="12" selected>Ежемесячно (12)</option><option value="4">Ежеквартально (4)</option><option value="1">Ежегодно (1)</option></select></label>
        </div>
        <div class="row two">
          <label>Срок, лет <span class="i" data-tip="Количество лет моделирования. Таблица и график строятся по годам.">i</span><input type="number" id="years" value="3" step="1" min="1"></label>
          <label>Инфляция, % <span class="i" data-tip="Сглаженно учитывается для столбца «Реально (с инфляцией)».">i</span><input type="number" id="infl" value="0" step="0.01"></label>
        </div>
        <div class="row two">
          <label>Момент пополнения <span class="i" data-tip="«В начале» — деньги в работе весь период; «В конце» — только со следующего.">i</span><select id="timing"><option value="begin" selected>В начале периода</option><option value="end">В конце периода</option></select></label>
          <label>Валюта <span class="i" data-tip="Символ валюты только для отображения. Расчёты без конвертации.">i</span><select id="currency"><option value="$" selected>$</option><option value="€">€</option><option value="₽">₽</option></select></label>
        </div>
        <div class="kpi">
          <div class="mini"><div class="label">Внесено, всего <span class="i" data-tip="Сумма всех регулярных пополнений за период (без стартового депозита).">i</span></div><div class="value" id="tcontrib">—</div></div>
          <div class="mini"><div class="label">Начислено процентов <span class="i" data-tip="Финальный баланс минус все внесения и старт.">i</span></div><div class="value" id="tinterest">—</div></div>
          <div class="mini"><div class="label">EAR (эффективная годовая) <span class="i" data-tip="(1 + r_net/n)^n − 1, где r_net = (ставка − комиссия)/100.">i</span></div><div class="value" id="earVal">—</div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="ctitle"><h3>Результаты</h3><span class="pill">График</span></div>
      <canvas id="chart"></canvas>
      <table>
        <thead><tr><th>Год</th><th>Баланс</th><th>Реально (с инфл.)</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="ctitle"><h3>Партнёрская программа (копитрейдинг)</h3><span class="pill">Доход от сети</span></div>
    <div class="fields">
      <label><input type="checkbox" id="affOn" checked> Учитывать партнёрские вознаграждения <span class="i" data-tip="Если выключить — вся партнёрка = 0.">i</span></label>
      <div class="hint">Ваш доход: <b>50% от собственной прибыли</b>. Уровни: L1 5%, L2 8%, L3 10%, L4 2%. Открываются: 1–2 ≥ $3k, 3 ≥ $10k, 4 ≥ $20k.</div>
      <div class="row two">
        <label>Средняя прибыль партнёра в месяц <span class="i" data-tip="Средняя чистая прибыль одного подключённого инвестора за месяц.">i</span><input type="number" id="affAvg" value="200" step="1" min="0"></label>
        <label>Месяцев учёта <span class="i" data-tip="На сколько месяцев считается партнёрский доход.">i</span><input type="number" id="affMonths" value="48" step="1" min="1"></label>
      </div>
      <div class="affGrid">
        <label>Партнёров 1-го уровня <span class="i" data-tip="Личные подключения. Вознаграждение 5% от их прибыли.">i</span><input type="number" id="affL1" value="20" min="0"></label>
        <label>Партнёров 2-го уровня <span class="i" data-tip="Подключения ваших L1. Вознаграждение 8%.">i</span><input type="number" id="affL2" value="50" min="0"></label>
        <label>Партнёров 3-го уровня <span class="i" data-tip="Вознаграждение 10% от прибыли их депозитов.">i</span><input type="number" id="affL3" value="100" min="0"></label>
        <label>Партнёров 4-го уровня <span class="i" data-tip="Вознаграждение 2%.">i</span><input type="number" id="affL4" value="300" min="0"></label>
      </div>

      <label style="margin-top:8px"><input type="checkbox" id="affAuto"> Считать среднюю прибыль партнёра автоматически <span class="i" data-tip="По распределению депозитов: $3k/$10k/$20k и текущей месячной доходности.">i</span></label>
      <div id="affAutoBox" style="display:none">
        <div class="row three">
          <label>% с депозитом $3,000<input type="number" id="affP3k" value="60" min="0" max="100" step="1"></label>
          <label>% с депозитом $10,000<input type="number" id="affP10k" value="30" min="0" max="100" step="1"></label>
          <label>% с депозитом $20,000<input type="number" id="affP20k" value="10" min="0" max="100" step="1"></label>
        </div>
        <div class="hint" id="affAutoHint">Итоговое распределение: 60% / 30% / 10%. Средняя прибыль: —</div>
      </div>

      <div class="kpi">
        <div class="mini"><div class="label">Месячная прибыль L1</div><div class="value" id="affL1Mon">—</div></div>
        <div class="mini"><div class="label">Месячная прибыль L2</div><div class="value" id="affL2Mon">—</div></div>
        <div class="mini"><div class="label">Месячная прибыль L3</div><div class="value" id="affL3Mon">—</div></div>
        <div class="mini"><div class="label">Месячная прибыль L4</div><div class="value" id="affL4Mon">—</div></div>
      </div>

      <div class="kpi">
        <div class="mini"><div class="label">Собственный доход (50% процентов)</div><div class="value" id="ownShare">—</div><div class="hint">Работает при депозите ≥ $3,000</div></div>
        <div class="mini"><div class="label">Партнёрский доход за период</div><div class="value" id="affTotal">—</div><div class="hint" id="affLevelsHint">Уровни: —</div></div>
        <div class="mini"><div class="label">Итого: собственный + партнёрский</div><div class="value" id="grandTotal">—</div><div class="hint" id="affPerMonth">В среднем в месяц: —</div></div>
      </div>

      <div class="card" style="background:rgba(255,255,255,.03);margin-top:10px">
        <h4 style="margin:6px 0 8px">Диаграмма партнёрской прибыли <span class="i" data-tip="Столбцы по уровням L1–L4: прибыль за 1 месяц, 1 год, 2 года, 3 года — разными цветами и с подписями сверху.">i</span></h4>
        <canvas id="affChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const i = id => document.getElementById(id);
function lcm(a,b){const g=(x,y)=>y===0?x:g(y,x%y);return a*b/g(a,b)}
function fmt(sym,n){return sym+' '+(+n).toLocaleString(undefined,{maximumFractionDigits:2})}
function clamp(x,minv,maxv){return Math.max(minv, Math.min(maxv, x));}

function simulate(params){
  const {initial,contrib,contribFreq,rate,fee,infl,compound,years,timing} = params;
  const n = Math.max(1, Math.floor(compound));
  const m = Math.max(0, Math.floor(contribFreq));
  const steps = (m===0? n : lcm(n,m));
  const compoundEvery = steps/n;
  const contribEvery = (m===0? Infinity : steps/m);
  const rNet = (rate - fee)/100;
  let bal = +initial||0, totalC=0, invested=+initial||0;
  const yearly=[], investedYearly=[];
  for(let y=1; y<=years; y++){
    for(let s=1;s<=steps;s++){
      if(timing==='begin' && ((s-1)%contribEvery===0) && params.contrib>0){ bal+=+params.contrib; totalC+=+params.contrib; invested+=+params.contrib; }
      if(s%compoundEvery===0){ bal *= 1 + (rNet/n); }
      if(timing==='end' && (s%contribEvery===0) && params.contrib>0){ bal+=+params.contrib; totalC+=+params.contrib; invested+=+params.contrib; }
    }
    const real = params.infl>0 ? bal/Math.pow(1+params.infl/100,y) : bal;
    yearly.push({year:y,balance:bal,real:+real.toFixed(2)});
    investedYearly.push(invested);
  }
  const ear = Math.pow(1 + (rNet/n), n) - 1;
  return {final:bal,totalC,interest:bal-(+initial+totalC),yearly,investedYearly,ear};
}

let chart=null, affChart=null;

function getParams(){
  return {
    initial:+i('initial').value||0,
    contrib:+i('contrib').value||0,
    contribFreq:+i('contribFreq').value||0,
    rate:+i('rate').value||0,
    fee:+i('fee').value||0,
    infl:+i('infl').value||0,
    compound:+i('compound').value||0,
    years:+i('years').value||0,
    timing:i('timing').value,
    currency:i('currency').value,
    mode:i('modeMonthly').checked?'monthly':'annual',
    mrate:+i('mrate')?.value||0,
    mvol:+i('mvol')?.value||0,
    affOn:i('affOn').checked, affAvg:+i('affAvg').value||0, affMonths:+i('affMonths').value||0, affL1:+i('affL1').value||0, affL2:+i('affL2').value||0, affL3:+i('affL3').value||0, affL4:+i('affL4').value||0,
    affAuto:i('affAuto').checked, affP3k:+i('affP3k').value||0, affP10k:+i('affP10k').value||0, affP20k:+i('affP20k').value||0
  };
}

function render(){
  const p=getParams();
  const isMonthly=(p.mode==='monthly');
  if(isMonthly){
    const m=(p.mrate||0)/100, d=Math.max(0,(p.mvol||0)/100);
    const ear=Math.pow(1+m,12)-1;
    const lo=Math.pow(1+clamp(m-d,-0.99,10),12)-1;
    const hi=Math.pow(1+clamp(m+d,-0.99,10),12)-1;
    i('earFromMonthly').textContent=(ear*100).toFixed(2)+'% ('+(lo*100).toFixed(1)+'%…'+(hi*100).toFixed(1)+'%)';
    p.rate=ear*100;
  }
  i('annualBox').style.display=isMonthly?'none':'';
  i('monthlyBox').style.display=isMonthly?'':'none';

  const r=simulate(p);
  const contributed = (p.contribFreq>0? p.years*p.contribFreq:0)*p.contrib;
  i('tcontrib').textContent=fmt(p.currency, contributed);
  i('tinterest').textContent=fmt(p.currency, r.interest);
  i('earVal').textContent=(r.ear*100).toFixed(2)+'%';
  const tb=i('tbody'); tb.innerHTML='';
  r.yearly.forEach(y=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${y.year}</td><td>${fmt(p.currency,y.balance)}</td><td>${fmt(p.currency,y.real)}</td>`; tb.appendChild(tr); });

  const labels=r.yearly.map(y=>y.year);
  const balances=r.yearly.map(y=>y.balance);
  const invested=r.investedYearly;
  const ctx=i('chart').getContext('2d'); if(chart) chart.destroy();
  chart=new Chart(ctx,{type:'line', data:{labels, datasets:[{label:'Внесено',data:invested,fill:true},{label:'Итог',data:balances,fill:false}]}});

  // Партнёрка: месячная и мульти-горизонты (с подписями)
  const dep=p.initial; const lvl1Open=dep>=3000, lvl2Open=dep>=3000, lvl3Open=dep>=10000, lvl4Open=dep>=20000;
  let avg=Math.max(0,p.affAvg);
  if(p.affAuto){
    const mEff=Math.pow(1+r.ear,1/12)-1;
    const w3=Math.max(0,p.affP3k), w10=Math.max(0,p.affP10k), w20=Math.max(0,p.affP20k);
    const sum=Math.max(1,w3+w10+w20);
    avg=(w3/sum)*(3000*mEff)+(w10/sum)*(10000*mEff)+(w20/sum)*(20000*mEff);
    i('affAutoHint').textContent=`Распределение: ${(w3/sum*100).toFixed(0)}% / ${(w10/sum*100).toFixed(0)}% / ${(w20/sum*100).toFixed(0)}%. Месячная доходность ≈ ${(mEff*100).toFixed(2)}%. Средняя прибыль партнёра: ${fmt(p.currency, avg)} в месяц.`;
  }
  const L=[(lvl1Open?p.affL1:0),(lvl2Open?p.affL2:0),(lvl3Open?p.affL3:0),(lvl4Open?p.affL4:0)];
  const R=[0.05,0.08,0.10,0.02];
  const Dm=L.map((n,i)=> (p.affOn? avg*(R[i]*n):0));
  const labelsL=['L1','L2','L3','L4'];
  const ac=i('affChart').getContext('2d'); if(affChart) affChart.destroy();
  affChart=new Chart(ac,{type:'bar', data:{labels:labelsL, datasets:[
    {label:'Месяц', data:Dm, color:'#6ec1ff', showValues:true},
    {label:'1 год', data:Dm.map(v=>v*12), color:'#ff8ea1', showValues:true},
    {label:'2 года', data:Dm.map(v=>v*24), color:'#8effa4', showValues:true},
    {label:'3 года', data:Dm.map(v=>v*36), color:'#f8d47b', showValues:true},
  ]}});

  // Итоги
  const affIncome=p.affOn? p.affMonths*(Dm[0]+Dm[1]+Dm[2]+Dm[3]):0;
  const ownIncome=(dep>=3000)? Math.max(0, r.interest*0.5):0;
  const grand=ownIncome+affIncome;
  i('ownShare').textContent=fmt(p.currency,ownIncome);
  i('affTotal').textContent=fmt(p.currency,affIncome);
  i('grandTotal').textContent=fmt(p.currency,grand);
  i('affPerMonth').textContent='В среднем в месяц: '+fmt(p.currency, grand/Math.max(1,p.affMonths));
  i('affLevelsHint').textContent='Уровни: 1:'+L[0]+' · 2:'+L[1]+' · 3:'+L[2]+' · 4:'+L[3];
}

function shareURL(){
  const p=getParams(); const u=new URL(location.href.split('?')[0]);
  Object.entries(p).forEach(([k,v])=>u.searchParams.set(k,String(v))); history.replaceState(null,'',u.toString()); return u.toString();
}

function bind(){
  const ids=['modeAnnual','modeMonthly','rate','fee','infl','compound','mrate','mvol','initial','contrib','contribFreq','years','timing','currency','affOn','affAvg','affMonths','affL1','affL2','affL3','affL4','affAuto','affP3k','affP10k','affP20k'];
  ids.forEach(id=>{ const el=i(id); if(!el) return; el.addEventListener('input',render); el.addEventListener('change',render); });
  i('btnReset').addEventListener('click', ()=>{ location.href = location.pathname; }); // сброс URL-параметров
  i('btnHelp').addEventListener('click', ()=>alert('Наведи на значки i рядом с полями — там пояснения и формулы.'));
  i('btnShare').addEventListener('click', ()=>{ const url=shareURL(); navigator.clipboard&&navigator.clipboard.writeText(url); alert('Ссылка скопирована\\n'+url); });
  i('btnPNG').addEventListener('click', ()=>{ const a=document.createElement('a'); a.href=document.querySelector('canvas').toDataURL('image/png'); a.download='zeus_calc.png'; a.click(); });
  i('btnPDF').addEventListener('click', ()=>window.print());
  i('btnCSV').addEventListener('click', ()=>{
    const p=getParams(); const r=simulate(p);
    const rows=[['Год','Баланс','Реально (с инфл.)']];
    r.yearly.forEach(y=>rows.push([y.year,y.balance,y.real]));
    rows.push([]); rows.push(['L','Месяц','1 год','2 года','3 года']);
    const dep=p.initial; const lvl1Open=dep>=3000, lvl2Open=dep>=3000, lvl3Open=dep>=10000, lvl4Open=dep>=20000;
    let avg=Math.max(0,p.affAvg); if(p.affAuto){ const mEff=Math.pow(1+r.ear,1/12)-1; const w3=p.affP3k, w10=p.affP10k, w20=p.affP20k; const sum=Math.max(1,w3+w10+w20); avg=(w3/sum)*(3000*mEff)+(w10/sum)*(10000*mEff)+(w20/sum)*(20000*mEff); }
    const L=[(lvl1Open?p.affL1:0),(lvl2Open?p.affL2:0),(lvl3Open?p.affL3:0),(lvl4Open?p.affL4:0)]; const R=[0.05,0.08,0.10,0.02];
    const Dm=L.map((n,i)=> (p.affOn? avg*(R[i]*n):0));
    [['L1',0],['L2',1],['L3',2],['L4',3]].forEach(([k,idx])=> rows.push([k, Dm[idx], Dm[idx]*12, Dm[idx]*24, Dm[idx]*36]));
    const csv=rows.map(r=> r.map(v=> `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\\n');
    const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download='zeus_calc.csv'; a.click();
  });
}

bind(); render();
</script>
</body>
</html>
