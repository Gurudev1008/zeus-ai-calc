<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ZEUS AI Calc — сложные проценты + партнёрка + сценарии</title>
<style>
:root{--bg:#071226;--panel:#0b1836;--panel2:#0a1532;--text:#eaf4ff;--muted:#a9c2ff;--bd:#39e9ff33}
*{box-sizing:border-box}
body{margin:0;background:radial-gradient(900px 520px at 85% 0, rgba(56,232,255,.08),transparent 70%),linear-gradient(180deg,#10275b,#071226);color:var(--text);font-family:Inter,system-ui}
.wrap{max-width:1280px;margin:0 auto;padding:22px 14px 44px}
.hdr{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
.badge{border:1px solid var(--bd);padding:6px 10px;border-radius:999px;background:linear-gradient(180deg,#0f2a63,#0b1c41)}
h1{margin:0;color:#98e9ff;font-size:22px}
.menu{display:flex;gap:8px;flex-wrap:wrap}
.btn{background:#102a64;border:1px solid var(--bd);color:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
.grid{display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
@media(max-width:1100px){.grid{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--bd);border-radius:16px;padding:14px;box-shadow:0 6px 22px rgba(56,232,255,.12)}
.ttl{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.pill{border:1px solid var(--bd);padding:3px 8px;border-radius:12px;color:#bfeaff;font-size:12px}
.row{display:grid;gap:10px}.two{grid-template-columns:repeat(2,minmax(160px,1fr))}
label{display:flex;flex-direction:column;gap:6px;font-size:13px;color:var(--muted)}
input,select{background:#0a1432;border:1px solid var(--bd);color:#fff;border-radius:10px;padding:10px 12px}
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
.kpi{background:rgba(255,255,255,.04);border:1px solid var(--bd);border-radius:12px;padding:10px}
.k{font-size:12px;color:#a9c2ff}.v{font-weight:700}
.canv{background:linear-gradient(180deg,#0a1840,#091537);border:1px solid var(--bd);border-radius:14px;padding:10px}
canvas{width:100%;height:360px;display:block}
.i{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;margin-left:6px;border-radius:50%;border:1px solid var(--bd);color:#9bdfff;font-size:12px;cursor:help;position:relative}
.i:hover::after{content:attr(data-tip);position:absolute;left:20px;top:-4px;min-width:220px;max-width:420px;background:#0a1840;color:#cfeaff;border:1px solid var(--bd);padding:8px 10px;border-radius:10px;white-space:normal;z-index:10}
.table{margin-top:8px;border:1px solid var(--bd);border-radius:12px;overflow:hidden}
thead th{background:#0a1840;color:#bfeaff}
th,td{padding:10px 12px;border-bottom:1px dashed #27406e}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.tab{padding:8px 12px;border:1px solid var(--bd);border-radius:999px;background:#0a1840;color:#bfeaff;cursor:pointer;user-select:none}
.tab.active{background:#12305e;color:#fff}
.legend{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--bd);border-radius:999px;padding:6px 10px;background:#0a1840}
.dot{width:10px;height:10px;border-radius:50%}
.note{font-size:12px;color:#9fb7ff;margin-top:6px}
.bad{opacity:.45;pointer-events:none}
hr.sep{border:0;border-top:1px dashed #27406e;margin:10px 0}
.sub{font-size:12px;color:#9fb7ff}
.scgrid{display:grid;gap:10px;grid-template-columns:repeat(3,minmax(180px,1fr))}
@media(max-width:900px){.scgrid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <div style="display:flex;gap:10px;align-items:center"><div class="badge">ZEUS&nbsp;AI</div><h1>Калькулятор сложных процентов</h1></div>
    <div class="menu">
      <button class="btn" id="btnReset">Сброс</button>
      <button class="btn" id="btnShare">Поделиться</button>
      <button class="btn" id="btnPNG">PNG (партнёрка)</button>
      <button class="btn" id="btnPDF">PDF</button>
      <button class="btn" id="btnCSV">CSV</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="ttl"><h3>Параметры</h3><span class="pill">ввод</span></div>
      <div class="row two">
        <label>Валюта <span class="i" data-tip="Только символ/лейбл для отображения (например, USDT или $). На расчёты не влияет.">i</span>
          <input id="currency" type="text" value="USDT" maxlength="12"></label>
        <label>Сумма депозита <span class="i" data-tip="Стартовый депозит. Пороги: ≥ $3,000 → собственный доход 50% и партнёрка 2 уровня; ≥ $10,000 → 60% и 3 уровня; ≥ $20,000 → 70% и 4 уровня.">i</span>
          <input id="initial" type="number" value="3000" min="0"></label>
      </div>
      <div class="row two">
        <label>Ежемесячная прибыль, % <span class="i" data-tip="Сколько % в месяц будет доход. Годовая прибыль рассчитывается автоматически.">i</span>
          <input id="mrate" type="number" value="5" step="0.01"></label>
        <label>Колебания в месяц, ± % <span class="i" data-tip="На сколько ставка может колебаться вверх/вниз каждый месяц. Используется для оценки средней годовой.">i</span>
          <input id="mvol" type="number" value="0" step="0.01"></label>
      </div>
      <div class="row two">
        <label>Комиссия, %/мес <span class="i" data-tip="Сколько уходит % в месяц на партнёрскую программу и комиссию проекта. Вычитается из ежемесячной прибыли.">i</span>
          <input id="mfee" type="number" value="0" step="0.01"></label>
        <label>Регулярное пополнение <span class="i" data-tip="Сколько готовы инвестировать каждый месяц для усиления сложного процента.">i</span>
          <input id="contrib" type="number" value="0" min="0"></label>
      </div>
      <div class="row two">
        <label>Капитализация <span class="i" data-tip="Как часто проценты добавляются к телу: 1/4/12 раз в год.">i</span>
          <select id="compound"><option value="12">Ежемесячно (12)</option><option value="4">Ежеквартально (4)</option><option value="1" selected>Ежегодно (1)</option></select></label>
        <label>Срок, лет <span class="i" data-tip="Горизонт моделирования по годам.">i</span>
          <input id="years" type="number" value="3" min="1" max="50"></label>
      </div>
      <div class="row two">
        <label>Инфляция, % <span class="i" data-tip="Используется для колонки «Реально (с инфл.)».">i</span>
          <input id="infl" type="number" value="0" step="0.01"></label>
        <label>Момент пополнения <span class="i" data-tip="«В начале» — взнос сразу работает; «В конце» — со следующего периода.">i</span>
          <select id="timing"><option value="begin" selected>В начале периода</option><option value="end">В конце периода</option></select></label>
      </div>
      <div class="kpis">
        <div class="kpi"><div class="k">Внесено, всего</div><div class="v" id="tcontrib">—</div></div>
        <div class="kpi"><div class="k">Начислено процентов</div><div class="v" id="tinterest">—</div></div>
        <div class="kpi"><div class="k">Годовая прибыль (EAR)</div><div class="v" id="earVal">—</div></div>
      </div>
      <div class="note" id="thresholdNote">Порог: —</div>
      <hr class="sep">
      <div class="ttl"><h3>Сравнение сценариев</h3><span class="pill">A/B/C</span></div>
      <div class="sub">Базовый сценарий использует параметры выше. Ниже можно включить ещё 1–2 сценария с отличающимися <b>ежемесячной прибылью</b>, <b>колебаниями</b>, <b>комиссией</b> и <b>взносом</b>. Остальные параметры общие.</div>
      <div class="scgrid">
        <div>
          <label><input type="checkbox" id="sc2on"> Включить сценарий B</label>
          <label>Метка B<input id="sc2label" value="B"></label>
          <label>Ежемес. прибыль, %<input id="sc2mrate" type="number" value="6" step="0.01"></label>
          <label>Колебания, ± %<input id="sc2mvol" type="number" value="1" step="0.01"></label>
          <label>Комиссия, %/мес<input id="sc2mfee" type="number" value="0" step="0.01"></label>
          <label>Ежемес. взнос<input id="sc2contrib" type="number" value="0"></label>
        </div>
        <div>
          <label><input type="checkbox" id="sc3on"> Включить сценарий C</label>
          <label>Метка C<input id="sc3label" value="C"></label>
          <label>Ежемес. прибыль, %<input id="sc3mrate" type="number" value="8" step="0.01"></label>
          <label>Колебания, ± %<input id="sc3mvol" type="number" value="2" step="0.01"></label>
          <label>Комиссия, %/мес<input id="sc3mfee" type="number" value="0" step="0.01"></label>
          <label>Ежемес. взнос<input id="sc3contrib" type="number" value="0"></label>
        </div>
        <div class="note">Совет: используйте A — консервативный, B — умеренный, C — оптимистичный.</div>
      </div>
    </div>

    <div class="card">
      <div class="ttl"><h3>Результаты</h3><span class="pill">график + таблица</span></div>
      <div class="canv"><canvas id="chart"></canvas></div>
      <div class="table">
        <table><thead><tr><th>Год</th><th>Баланс</th><th>Реально (с инфл.)</th></tr></thead><tbody id="tbody"></tbody></table>
      </div>
      <div class="ttl" style="margin-top:10px"><h3>Авто‑отчёт</h3><span class="pill">summary</span></div>
      <div id="report" class="note">—</div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="ttl"><h3>Партнёрская программа</h3><span class="pill">копитрейдинг</span></div>
    <div class="row two">
      <label><span>Учитывать партнёрку <span class="i" data-tip="Отключите, чтобы считать только собственный вклад.">i</span></span>
        <input id="affOn" type="checkbox" checked></label>
      <label>Средняя прибыль партнёра / месяц <span class="i" data-tip="Средняя чистая прибыль одного инвестора в месяц (в валюте интерфейса).">i</span>
        <input id="affAvg" type="number" value="200" min="0"></label>
    </div>
    <div class="row two">
      <label>Месяцев учёта <span class="i" data-tip="На сколько месяцев суммировать партнёрский доход.">i</span>
        <input id="affMonths" type="number" value="48" min="1"></label>
      <span class="note">Ставки уровней по умолчанию: L1 5%, L2 8%, L3 10%, L4 2%.</span>
    </div>
    <div class="row two">
      <label id="lblL1">L1 — личные <span class="i" data-tip="Ваши прямые подключения (5%).">i</span>
        <input id="affL1" type="number" value="20" min="0"></label>
      <label id="lblL2">L2 — партнёры L1 <span class="i" data-tip="Приходят от ваших L1 (8%).">i</span>
        <input id="affL2" type="number" value="50" min="0"></label>
    </div>
    <div class="row two">
      <label id="lblL3">L3 — партнёры L2 <span class="i" data-tip="Третий уровень сети (10%).">i</span>
        <input id="affL3" type="number" value="100" min="0"></label>
      <label id="lblL4">L4 — глубина <span class="i" data-tip="Четвёртый уровень сети (2%).">i</span>
        <input id="affL4" type="number" value="300" min="0"></label>
    </div>

    <div class="tabs">
      <div class="tab active" data-view="all">Все уровни</div>
      <div class="tab" data-view="l1">L1</div>
      <div class="tab" data-view="l2">L2</div>
      <div class="tab" data-view="l3">L3</div>
      <div class="tab" data-view="l4">L4</div>
      <div class="tab" data-view="own">Собственный</div>
    </div>
    <div class="legend">
      <div class="chip"><span class="dot" style="background:#6ec1ff"></span> Месяц</div>
      <div class="chip"><span class="dot" style="background:#ff8ea1"></span> 1 год</div>
      <div class="chip"><span class="dot" style="background:#8effa4"></span> 2 года</div>
      <div class="chip"><span class="dot" style="background:#f8d47b"></span> 3 года</div>
    </div>
    <div class="canv"><canvas id="affChart"></canvas></div>
    <div class="kpis">
      <div class="kpi"><div class="k">Собственный доход</div><div class="v" id="ownShare">—</div></div>
      <div class="kpi"><div class="k">Партнёрский доход за период</div><div class="v" id="affTotal">—</div></div>
      <div class="kpi"><div class="k">Итого</div><div class="v" id="grandTotal">—</div></div>
    </div>
    <div class="note" id="affPerMonth">В среднем в месяц: —</div>
  </div>
</div>

<script>
/* === Lightweight offline chart renderer: line + grouped bars === */
(function(global){
  function Legend(ctx, labels, colors, x, y){
    ctx.font="12px Inter,Arial"; ctx.textBaseline="middle";
    let off=0; labels.forEach((lab,idx)=>{ const col=colors[idx%colors.length];
      ctx.fillStyle=col; ctx.fillRect(x+off,y-6,12,12);
      ctx.fillStyle="#cfeaff"; ctx.fillText(lab,x+off+16,y);
      off += ctx.measureText(lab).width + 36;
    });
  }
  function scale(arr){ let min=Math.min(...arr), max=Math.max(...arr);
    if(!isFinite(min)||!isFinite(max)){min=0;max=1;} if(min===max) max=min+1;
    return {min,max};
  }
  class Chart{
    constructor(ctx, cfg){ this.ctx=ctx; this.cfg=JSON.parse(JSON.stringify(cfg||{})); this._dead=false; this.draw(); }
    destroy(){ this._dead=true; this.ctx=null; this.cfg=null; }
    update(){ this.draw(); }
    draw(){
      if(this._dead) return;
      const c=this.ctx.canvas, ctx=this.ctx, dpr=window.devicePixelRatio||1;
      c.width=c.clientWidth*dpr; c.height=c.clientHeight*dpr; ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.clearRect(0,0,c.clientWidth,c.clientHeight);
      const pad={l:60,r:24,t:36,b:34}, W=c.clientWidth, H=c.clientHeight, aw=W-pad.l-pad.r, ah=H-pad.t-pad.b;
      const labels=(this.cfg.data&&this.cfg.data.labels)||[], ds=(this.cfg.data&&this.cfg.data.datasets)||[];
      ctx.strokeStyle="rgba(160,200,255,.25)"; ctx.lineWidth=1; ctx.beginPath();
      ctx.moveTo(pad.l,pad.t); ctx.lineTo(pad.l,H-pad.b); ctx.lineTo(W-pad.r,H-pad.b); ctx.stroke();
      const all=[]; ds.forEach(s=>(s.data||[]).forEach(v=>{ if(isFinite(v)) all.push(v);}));
      const ys=scale(all.length?all:[0,1]); const y0=Math.min(0,ys.min), y1=ys.max*1.15;
      const xPos=i=>(labels.length<=1)? pad.l+aw*0.05+i*30 : pad.l+(i/(labels.length-1))*aw;
      const yPos=v=> (H-pad.b) - ((v-y0)/Math.max(1e-9,(y1-y0)))*ah;
      ctx.fillStyle="#9fb7ff"; ctx.font="12px Inter,Arial";
      for(let t=0;t<=6;t++){ const v=y0+(y1-y0)*t/6, y=yPos(v);
        ctx.strokeStyle="rgba(160,200,255,.12)"; ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(W-pad.r,y); ctx.stroke();
        ctx.fillText(v.toLocaleString(undefined,{maximumFractionDigits:0}), 10,y);
      }
      const pal=["#6ec1ff","#ff8ea1","#8effa4","#f8d47b","#caa0ff","#73e3e8"], gW=(labels.length? aw/labels.length:50);
      ds.forEach((s,di)=>{
        const col=s.color||pal[di%pal.length];
        if((this.cfg.type||"line")==="line"){
          ctx.strokeStyle=col; ctx.lineWidth=2.2; ctx.beginPath();
          (s.data||[]).forEach((v,i)=>{ const x=xPos(i), y=yPos(v); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
          ctx.stroke();
          if(s.fill){ const base=yPos(0); ctx.lineTo(xPos((s.data||[]).length-1),base); ctx.lineTo(xPos(0),base); ctx.closePath(); ctx.fillStyle=col+"33"; ctx.fill(); }
        } else if(this.cfg.type==="bar"){
          const k=Math.max(1,ds.length), bw=gW*0.66/k, sh=(k*bw)/2;
          (s.data||[]).forEach((v,i)=>{ const cx=xPos(i), x=cx-sh+di*bw+2, y=yPos(v), base=yPos(0);
            ctx.fillStyle=col; const h=Math.abs(base-y), yy=Math.min(y,base), r=Math.min(8,h/2);
            ctx.beginPath(); ctx.moveTo(x,yy+h); ctx.lineTo(x,yy+r);
            ctx.quadraticCurveTo(x,yy,x+r,yy); ctx.lineTo(x+bw-r,yy);
            ctx.quadraticCurveTo(x+bw,yy,x+bw,yy+r); ctx.lineTo(x+bw,yy+h);
            ctx.closePath(); ctx.fill();
            if(s.showValues){ ctx.fillStyle="#d7eaff"; ctx.font="11px Inter,Arial"; ctx.textAlign="center";
              ctx.fillText(((v||0)).toLocaleString(undefined,{maximumFractionDigits:0}), x+bw/2, yy-6);
            }
          });
        }
      });
      Legend(ctx, ds.map(x=>x.label||""), pal, pad.l, 16);
    }
  }
  global.Chart = Chart;
})(this);
</script>

<script>
const i = id => document.getElementById(id);
const clamp = (x,lo,hi)=>Math.max(lo,Math.min(hi,x));
function lcm(a,b){const g=(x,y)=>y===0?x:g(y,x%y);return a*b/g(a,b)}
function fmt(sym,n){const s = sym? (sym+' ') : ''; return s + (+n).toLocaleString(undefined,{maximumFractionDigits:2})}
function getNum(el){const v=parseFloat(el.value);return isFinite(v)?v:0}

function thresholds(initial){
  if(initial>=20000) return { ownShare:0.70, levels:4, label:"70% • L1–L4" };
  if(initial>=10000) return { ownShare:0.60, levels:3, label:"60% • L1–L3" };
  if(initial>=3000)  return { ownShare:0.50, levels:2, label:"50% • L1–L2" };
  return { ownShare:0.00, levels:0, label:"нет собственных %, партнёрка выключена" };
}

function loadFromURL(){
  const q=new URLSearchParams(location.search);
  ["currency","initial","mrate","mvol","mfee","contrib","compound","years","infl","timing","affOn","affAvg","affMonths","affL1","affL2","affL3","affL4",
   "sc2on","sc2label","sc2mrate","sc2mvol","sc2mfee","sc2contrib","sc3on","sc3label","sc3mrate","sc3mvol","sc3mfee","sc3contrib"]
    .forEach(k=>{ if(q.has(k)){ const el=i(k); if(!el) return;
      if(el.type==="checkbox") el.checked = q.get(k)==="true"||q.get(k)==="1"; else el.value = q.get(k);
    }});
}

function shareURL(){
  const q=new URLSearchParams();
  ["currency","initial","mrate","mvol","mfee","contrib","compound","years","infl","timing","affOn","affAvg","affMonths","affL1","affL2","affL3","affL4",
   "sc2on","sc2label","sc2mrate","sc2mvol","sc2mfee","sc2contrib","sc3on","sc3label","sc3mrate","sc3mvol","sc3mfee","sc3contrib"]
    .forEach(k=>{ const el=i(k); if(!el) return; const v = (el.type==="checkbox")? String(el.checked) : el.value; q.set(k,v); });
  const url = location.origin + location.pathname + "?" + q.toString();
  history.replaceState(null,"",url);
  if(navigator.clipboard){ navigator.clipboard.writeText(url); alert("Ссылка скопирована"); }
}

function yearlyRateFromMonthly(mrate, mvol, mfee){
  const m     = (mrate - mfee)/100;
  const mLow  = (mrate - mvol - mfee)/100;
  const mHigh = (mrate + mvol - mfee)/100;
  const clampM = v => clamp(v, -0.99, 1000);
  const EAR_low  = Math.pow(1+clampM(mLow),12)-1;
  const EAR_high = Math.pow(1+clampM(mHigh),12)-1;
  const EAR_avg  = Math.sqrt((1+EAR_low)*(1+EAR_high)) - 1;
  return {EAR_avg};
}

function simulate(p){
  const rYear = yearlyRateFromMonthly(p.mrate,p.mvol,p.mfee).EAR_avg;
  const n = Math.max(1, Math.floor(p.compound));
  const mContrib = p.contrib>0 ? 12 : 0;
  const steps = mContrib? lcm(n,12) : n;
  const capEvery = steps/n;
  const contEvery = mContrib? steps/12 : Infinity;
  let bal = p.initial||0, invested = p.initial||0, sumContrib=0;
  const rows=[], investedYearly=[];
  for(let y=1;y<=p.years;y++){
    for(let s=1;s<=steps;s++){
      if(p.timing==='begin' && ((s-1)%contEvery===0) && p.contrib>0){ bal+=p.contrib; sumContrib+=p.contrib; invested+=p.contrib; }
      if(s%capEvery===0){ bal *= (1 + rYear/n); }
      if(p.timing==='end' && (s%contEvery===0) && p.contrib>0){ bal+=p.contrib; sumContrib+=p.contrib; invested+=p.contrib; }
    }
    const real = p.infl>0 ? bal/Math.pow(1+p.infl/100,y) : bal;
    rows.push({year:y, balance:bal, real}); investedYearly.push(invested);
  }
  const interest = bal - (p.initial + sumContrib);
  return { rows, investedYearly, interest, ear:rYear };
}

const levelRates=[0.05,0.08,0.10,0.02];
function partner(p, interest, ownShare, levels){
  const effCounts=[p.affL1,p.affL2,p.affL3,p.affL4].map((v,idx)=> idx<levels ? v : 0);
  const mon = effCounts.map((cnt,idx)=> p.affOn? (p.affAvg * levelRates[idx] * cnt) : 0);
  const affIncome = p.affOn ? p.affMonths * mon.reduce((a,b)=>a+b,0) : 0;
  const ownIncome = ownShare * Math.max(0, interest);
  const total = ownIncome + affIncome;
  const avgPerMonth = total / Math.max(1,p.affMonths);
  return { mon, affIncome, ownIncome, total, avgPerMonth };
}

function getBaseParams(){
  return {
    currency: i('currency').value.trim(),
    initial:  getNum(i('initial')),
    mrate:    getNum(i('mrate')),
    mvol:     getNum(i('mvol')),
    mfee:     getNum(i('mfee')),
    contrib:  getNum(i('contrib')),
    compound: parseInt(i('compound').value,10)||1,
    years:    parseInt(i('years').value,10)||1,
    infl:     getNum(i('infl')),
    timing:   i('timing').value,
    affOn:    i('affOn').checked,
    affAvg:   getNum(i('affAvg')),
    affMonths:parseInt(i('affMonths').value,10)||1,
    affL1:    parseInt(i('affL1').value,10)||0,
    affL2:    parseInt(i('affL2').value,10)||0,
    affL3:    parseInt(i('affL3').value,10)||0,
    affL4:    parseInt(i('affL4').value,10)||0
  };
}
function getScenarioParams(base){
  const arr=[{label:'A', ...base}];
  if(i('sc2on').checked){
    arr.push({label:(i('sc2label').value||'B'), ...base,
      mrate:getNum(i('sc2mrate')), mvol:getNum(i('sc2mvol')), mfee:getNum(i('sc2mfee')), contrib:getNum(i('sc2contrib'))
    });
  }
  if(i('sc3on').checked){
    arr.push({label:(i('sc3label').value||'C'), ...base,
      mrate:getNum(i('sc3mrate')), mvol:getNum(i('sc3mvol')), mfee:getNum(i('sc3mfee')), contrib:getNum(i('sc3contrib'))
    });
  }
  return arr;
}

let mainChart=null, affChart=null, currentView='all';

function render(){
  const p0=getBaseParams();
  const th = thresholds(p0.initial);
  i('thresholdNote').textContent = "Порог: " + th.label;
  [['lblL1',0],['lblL2',1],['lblL3',2],['lblL4',3]].forEach(([id,idx])=>{
    const wrap = i(id), input = i('affL'+(idx+1));
    const active = (idx < th.levels);
    wrap.classList.toggle('bad', !active);
    input.disabled = !active;
    if(!active) input.value = "0";
  });

  const scenarios = getScenarioParams(p0);
  const results = scenarios.map(s => ({p:s, sim:simulate(s)}));

  const base = results[0];
  const contributed = base.p.contrib>0 ? (base.p.years*12*base.p.contrib) : 0;
  i('tcontrib').textContent = fmt(base.p.currency, contributed);
  i('tinterest').textContent = fmt(base.p.currency, base.sim.interest);
  i('earVal').textContent = (base.sim.ear*100).toFixed(2) + "%";

  const tb=i('tbody'); tb.innerHTML="";
  base.sim.rows.forEach(row=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${row.year}</td><td style="text-align:right">${fmt(base.p.currency,row.balance)}</td><td style="text-align:right">${fmt(base.p.currency,row.real)}</td>`;
    tb.appendChild(tr);
  });

  const labels=base.sim.rows.map(x=>x.year);
  const ctx=i('chart').getContext('2d'); if(mainChart) mainChart.destroy();
  const palette=["#6ec1ff","#ff8ea1","#8effa4"];
  const datasets = results.map((r,idx)=> ({
    label:`${r.p.label} — Итог`,
    data:r.sim.rows.map(x=>x.balance),
    fill:false,
    color:palette[idx%palette.length]
  }));
  datasets.unshift({label:`A — Внесено`, data:base.sim.investedYearly, fill:true, color:"#6ec1ff"});
  mainChart=new Chart(ctx,{type:'line', data:{labels, datasets}});

  const aff = partner(base.p, base.sim.interest, th.ownShare, th.levels);
  i('ownShare').textContent = fmt(base.p.currency, aff.ownIncome);
  i('affTotal').textContent = fmt(base.p.currency, aff.affIncome);
  i('grandTotal').textContent = fmt(base.p.currency, aff.total);
  i('affPerMonth').textContent = "В среднем в месяц: " + fmt(base.p.currency, aff.avgPerMonth);

  const ac=i('affChart').getContext('2d'); if(affChart) affChart.destroy();
  function ds(v){ return [
    {label:'Месяц', data:v, color:'#6ec1ff', showValues:true},
    {label:'1 год', data:v.map(x=>x*12), color:'#ff8ea1', showValues:true},
    {label:'2 года', data:v.map(x=>x*24), color:'#8effa4', showValues:true},
    {label:'3 года', data:v.map(x=>x*36), color:'#f8d47b', showValues:true},
  ];}
  let data;
  if(currentView==='all'){ data = { labels:['L1','L2','L3','L4'], datasets: ds(aff.mon) }; }
  else if(currentView==='own'){ const m = aff.ownIncome / Math.max(1,base.p.affMonths); data = { labels:['Own'], datasets: ds([m]) }; }
  else { const map = {l1:0,l2:1,l3:2,l4:3}; const idx=map[currentView]; data = { labels:[currentView.toUpperCase()], datasets: ds([aff.mon[idx]]) }; }
  affChart=new Chart(ac,{type:'bar', data});

  const y1 = base.sim.rows[0]?.balance || 0;
  const y1r = base.sim.rows[0]?.real || 0;
  const last = base.sim.rows[base.sim.rows.length-1]?.balance || 0;
  const lastr = base.sim.rows[base.sim.rows.length-1]?.real || 0;
  let report = `📈 Через 1 год по сценарию A у вас будет ${fmt(base.p.currency,y1)} (реально: ${fmt(base.p.currency,y1r)}).`;
  report += `<br>💰 К концу срока: ${fmt(base.p.currency,last)} (реально: ${fmt(base.p.currency,lastr)}). Начисленные проценты: ${fmt(base.p.currency, base.sim.interest)}.`;
  report += `<br>🤝 Партнёрская программа: собственный доход ${fmt(base.p.currency,aff.ownIncome)}, партнёрский за период ${fmt(base.p.currency,aff.affIncome)}.`;
  if(results.length>1){
    report += `<br><br><b>Сравнение:</b>`;
    const baseLast = last;
    results.slice(1).forEach(r=>{
      const rlast = r.sim.rows[r.sim.rows.length-1]?.balance || 0;
      const delta = rlast - baseLast;
      report += `<br>• ${r.p.label}: итог ${fmt(base.p.currency,rlast)} (${delta>=0?'+':''}${fmt('',delta)} к A)`;
    });
  }
  i('report').innerHTML = report;
}

function bind(){
  const ids=['currency','initial','mrate','mvol','mfee','contrib','compound','years','infl','timing','affOn','affAvg','affMonths','affL1','affL2','affL3','affL4',
  'sc2on','sc2label','sc2mrate','sc2mvol','sc2mfee','sc2contrib','sc3on','sc3label','sc3mrate','sc3mvol','sc3mfee','sc3contrib'];
  ids.forEach(id=>{ const el=i(id); if(el){ el.addEventListener('input',render); el.addEventListener('change',render); }});
  document.querySelectorAll('.tab').forEach(t=> t.addEventListener('click',()=>{ currentView = t.dataset.view; document.querySelectorAll('.tab').forEach(x=>x.classList.toggle('active', x===t)); render(); }));
  i('btnReset').addEventListener('click',()=>{ location.href = location.pathname; });
  i('btnShare').addEventListener('click', shareURL);
  i('btnPNG').addEventListener('click', ()=>{ const a=document.createElement('a'); a.href=i('affChart').toDataURL('image/png'); a.download='partner_chart.png'; a.click(); });
  i('btnPDF').addEventListener('click', ()=>window.print());
  i('btnCSV').addEventListener('click', ()=>{
    const p=getBaseParams(), r=simulate(p);
    const th=thresholds(p.initial), aff=partner(p, r.interest, th.ownShare, th.levels);
    const rows=[["Год","Баланс","Реально (с инфл.)"]];
    r.rows.forEach(row=>rows.push([row.year,row.balance,row.real]));
    rows.push([]); rows.push(["Партнёрка","Месяц","1 год","2 года","3 года"]);
    [["L1",0],["L2",1],["L3",2],["L4",3]].forEach(([name,idx])=>rows.push([name, aff.mon[idx], aff.mon[idx]*12, aff.mon[idx]*24, aff.mon[idx]*36]));
    rows.push([]); rows.push(["Собственный доход", aff.ownIncome]); rows.push(["Партнёрский доход", aff.affIncome]); rows.push(["Итого", aff.total]);
    const csv = rows.map(r=>r.map(v=>`"${String(v??"").replace(/"/g,'""')}"`).join(",")).join("\n");
    const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download='zeus_calc.csv'; a.click();
  });
}

loadFromURL(); bind(); render();
</script>
</body>
</html>
